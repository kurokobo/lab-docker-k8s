# Kubernetes Lab： その他の要素

このラボでは取り扱いませんが、いくつかの追加の概念を紹介します。

## データの永続化

Docker のラボで、コンテナはステートレスであり、データの永続化のためには別途 **ボリューム** の概念を持ち込む必要があることを学習しました。同様のことは Kubernetes でももちろん言えます。例えば、これまでの作業でも、マニフェストを使って再デプロイした後は、データベースのカウンタはリセットされていたはずです。

Kubernetes にも **Persistent Volume** というデータの永続化のための仕組みがあります。全ノードからアクセス可能な何らかのストレージを用意し、Kubernetes 側でも適切にリソースを定義すれば、Pod にその領域をマウントでき、データが永続化されるようになります。

ストレージには NFS など一般的な共有ファイルシステムも利用できますし、ストレージ側でインテグレーションの機能（CSI）を持っていれば、Kubernetes からストレージのネイティブのボリューム作成機能などとも連携可能です。

また、パブリッククラウド上で Kubernetes クラスタを構成した場合は、そのパブリッククラウドの別のストレージサービスを Kubernetes の永続ボリューム領域として使える場合がほとんどです。

興味があれば調べてみるとよいでしょう。

## シェルの利用やコマンドの実行

Docker コンテナと同様、Kubernetes でも Pod（の中のコンテナ）のシェルにアクセスできます。もちろん、コンテナ内にシェルのバイナリがある必要がありますし、必ずしも `bash` ではなく、`sh` や `ash` など別のシェルである可能性もあります。また、任意のコマンドも実行可能です。

```bash
kubectl exec -it <Pod 名> bash
kubectl exec <Pod 名> env
```

単一の Pod に複数のコンテナが存在している場合は、`-c` でコンテナの指定を追加します。

```bash
kubectl exec -it <Pod 名> -c <コンテナ名> bash
kubectl exec <Pod 名> -c <コンテナ名> env
```

## Kustomize によるマニフェストの管理

アプリケーションの構成が複雑になってくると、管理すべきマニフェストファイルも、アプリケーション別、環境別に複数ファイルに分かれるようになり、相応に複雑になってきます。

こうしたときに、**Kustomize** を利用すると、マニフェストを共通化しつつ環境ごとに一部の値を変更してデプロイしたり、任意のマニフェストファイルをまとめて適用したりできて、たいへん便利です。

Kustomize の基本的な機能は最近の `kubectl` には組み込まれており、[Kustomization ファイル](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/) を用意すれば今回のラボ環境でもすぐに利用できます。詳細は [ドキュメント](https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/) で確認できます。

## Helm によるさらなる活用

**Helm** を利用すると、マニフェストすら作らずに簡単に Kubernetes 上に完全に機能するアプリケーションを展開できます。

イメージでいうと、**`apt` や `yum`（`dnf`）でパッケージをインストールするのに近しい操作感**です。Helm Hub などで既成パッケージが多数公開されていますので、興味があればこちらも調べてみるとよいでしょう。
